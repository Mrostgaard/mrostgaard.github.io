<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Using Nextcloud calendar in Emacs</title>
    <meta name="Description" content="Nextcloud --&gt; org-caldav --&gt; calfw-org --&gt; emacs-calfw">
    <link rel="stylesheet" href="/css/index.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/prism-base16-monokai.dark.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Rostgaard.IT">
    <link href="https://fonts.googleapis.com/css?family=Noto+Serif+JP&display=swap" rel="stylesheet"> 
    <link href="https://fonts.googleapis.com/css?family=Indie+Flower&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">

  </head>
  <body>
    <header>
      <h1 class="home"><a href="/">Rostgaard.IT</a></h1>
      <ul class="nav"><li class="nav-item">
          <a href="/">[ About ]</a>
        </li><li class="nav-item">
          <a href="/posts/">[ Posts ]</a>
        </li></ul>
    </header>

    <main class="tmpl-post">
      <p><a href="/">← Home</a></p>
<h1>Using Nextcloud calendar in Emacs</h1>
<div class="post card">
     <small>created: <i>Wed Oct 21 2020</i> </small>
     <p>If you don't care about an introduction to my issue, please <a href="##Implementation">click here</a> to get to the implementation details.</p>
<p>So, having recently bought a new computer, I decided to install Arch and get Doom emacs up and running probably. The problem (mostly with Arch) is that I couldn't find any</p>
<h2 id="implementation">Implementation <a class="direct-link" href="#implementation">#</a></h2>
<p>The problem is that we want <a href="https://github.com/kiwanami/emacs-calfw">emacs-calfw</a> to support caldav, which is the format we get from the Nextcloud server. This is a 'easy' fix by using <a href="https://github.com/kidd/org-gcal.el">org-caldav</a></p>
<pre class="language-lisp"><code class="language-lisp"><span class="highlight-line"># For doom emacs this to your ~/.doom.d/packages.el  </span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token car">package!</span> org-caldav<span class="token punctuation">)</span>  </span><br><span class="highlight-line"></span><br><span class="highlight-line"></span><br><span class="highlight-line"># ~/.doom.d/config.el  </span><br><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">use-package</span> org-caldav</span><br><span class="highlight-line">  <span class="token lisp-property property">:init</span></span><br><span class="highlight-line">  <span class="token comment">;; This is the sync on close function; it also prompts for save after syncing so</span></span><br><span class="highlight-line">  <span class="token comment">;; no late changes get lost</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">org-caldav-sync-at-close</span> <span class="token punctuation">(</span><span class="token arguments"></span><span class="token punctuation">)</span></span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token car">org-caldav-sync</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token car">save-some-buffers</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">;; This is the delayed sync function; it waits until emacs has been idle for</span></span><br><span class="highlight-line">  <span class="token comment">;; "secs" seconds before syncing.  The delay is important because the caldav-sync</span></span><br><span class="highlight-line">  <span class="token comment">;; can take five or ten seconds, which would be painful if it did that right at save.</span></span><br><span class="highlight-line">  <span class="token comment">;; This way it just waits until you've been idle for a while to avoid disturbing</span></span><br><span class="highlight-line">  <span class="token comment">;; the user.</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token defvar"><span class="token keyword">defvar</span> <span class="token variable">org-caldav-sync-timer</span></span> <span class="token boolean">nil</span></span><br><span class="highlight-line">     <span class="token string">"Timer that <span class="token symbol">`org-caldav-push-timer'</span> used to reschedule itself, or nil."</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">org-caldav-sync-with-delay</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">secs</span></span><span class="token punctuation">)</span></span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">when</span> org-caldav-sync-timer</span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token car">cancel-timer</span> org-caldav-sync-timer<span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token keyword">setq</span> org-caldav-sync-timer</span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token car">run-with-idle-timer</span></span><br><span class="highlight-line">       <span class="token punctuation">(</span><span class="token car">*</span> <span class="token number">1</span> secs<span class="token punctuation">)</span> <span class="token boolean">nil</span> <span class="token quoted-symbol variable symbol">'org-caldav-sync</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token comment">;; Actual calendar configuration edit this to meet your specific needs</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">setq</span> org-caldav-url <span class="token string">"https://[SERVER]/remote.php/dav/calendars/[USERNAME]/"</span><span class="token punctuation">)</span></span><br><span class="highlight-line">      <span class="token punctuation">(</span><span class="token keyword">setq</span> org-caldav-calendars</span><br><span class="highlight-line">    <span class="token punctuation">'(</span><span class="token punctuation">(</span><span class="token lisp-property property">:calendar-id</span> <span class="token string">"personal"</span></span><br><span class="highlight-line">            <span class="token lisp-property property">:files</span> <span class="token punctuation">(</span><span class="token string">"~/location/for/calendar/personal-cal.org"</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token lisp-property property">:inbox</span> <span class="token string">"~/location/for/calendar/personal-caldav-inbox.org"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">setq</span> org-caldav-backup-file <span class="token string">"~/location/for/calendar/org-caldav/org-caldav-backup.org"</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">setq</span> org-caldav-save-directory <span class="token string">"~/location/for/calendar/org-caldav/"</span><span class="token punctuation">)</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">  <span class="token lisp-property property">:config</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">setq</span> org-icalendar-alarm-time <span class="token number">1</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token comment">;; This makes sure to-do items as a category can show up on the calendar</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">setq</span> org-icalendar-include-todo <span class="token boolean">t</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token comment">;; This ensures all org "deadlines" show up, and show up as due dates</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">setq</span> org-icalendar-use-deadline <span class="token punctuation">'(</span><span class="token car">event-if-todo</span> event-if-not-todo todo-due<span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token comment">;; This ensures "scheduled" org items show up, and show up as start times</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token keyword">setq</span> org-icalendar-use-scheduled <span class="token punctuation">'(</span><span class="token car">todo-start</span> event-if-todo event-if-not-todo<span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token comment">;; Add the delayed save hook with a five minute idle timer</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token car">add-hook</span> <span class="token quoted-symbol variable symbol">'after-save-hook</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token lambda"><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token arguments"></span><span class="token punctuation">)</span></span></span><br><span class="highlight-line">          <span class="token punctuation">(</span><span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token car">eq</span> major-mode <span class="token quoted-symbol variable symbol">'org-mode</span><span class="token punctuation">)</span></span><br><span class="highlight-line">        <span class="token punctuation">(</span><span class="token car">org-caldav-sync-with-delay</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token comment">;; Add the close emacs hook</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token car">add-hook</span> <span class="token quoted-symbol variable symbol">'kill-emacs-hook</span> <span class="token quoted-symbol variable symbol">'org-caldav-sync-at-close</span><span class="token punctuation">)</span></span></code></pre>
<p>To avoid having to write username and password in everytime you want to sync a new session you can create or edit a .netrc file in your home directory <a href="https://github.com/dengste/org-caldav#storing-authentication-information-in-authinfonetrc">(documentation)</a>:</p>
<pre class="language-bash"><code class="language-bash"><span class="highlight-line"><span class="token function">vim</span> ~/.netrc</span></code></pre>
<p>and then write:</p>
<pre class="language-bash"><code class="language-bash"><span class="highlight-line">machine https://<span class="token punctuation">[</span>SERVER-URL<span class="token punctuation">]</span>/ <span class="token comment"># e.g: https://cloud.example.net/</span></span><br><span class="highlight-line">login <span class="token punctuation">[</span>username<span class="token punctuation">]</span></span><br><span class="highlight-line">password <span class="token punctuation">[</span>password<span class="token punctuation">]</span></span></code></pre>
<p>Then you run:</p>
<pre class="language-lisp"><code class="language-lisp"><span class="highlight-line">M-x org-caldav-sync</span></code></pre>
<p>to sync your appointmens with your inbox.</p>
<p>Now look at your <i>~/location/for/calendar/personal-caldav-inbox.org</i> file and check that the file has been updated with your calendar details.</p>
<p>We now need to let <a href="https://github.com/kiwanami/emacs-calfw">emacs-calfw</a> know about out new org files (which it can read). To do this, add this config.el file:</p>
<pre class="language-lisp"><code class="language-lisp"><span class="highlight-line"><span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">my-open-calendar</span> <span class="token punctuation">(</span><span class="token arguments"></span><span class="token punctuation">)</span></span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token interactive keyword">interactive</span><span class="token punctuation">)</span></span><br><span class="highlight-line">  <span class="token punctuation">(</span><span class="token car">cfw</span><span class="token lisp-property property">:open-calendar-buffer</span></span><br><span class="highlight-line">   <span class="token lisp-property property">:contents-sources</span></span><br><span class="highlight-line">   <span class="token punctuation">(</span><span class="token car">list</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token car">cfw</span><span class="token lisp-property property">:org-create-source</span> <span class="token string">"Green"</span><span class="token punctuation">)</span>  <span class="token comment">; org-agenda source</span></span><br><span class="highlight-line">    <span class="token comment">;(cfw:ical-create-source "nextcloud" "https://cloud.rostgaard.it/remote.php/dav/calendars/root/personal?export" "IndianRed") ; google calendar ICS</span></span><br><span class="highlight-line">    <span class="token punctuation">(</span><span class="token car">cfw</span><span class="token lisp-property property">:ical-create-source</span> <span class="token string">"nextcloud"</span> <span class="token string">"https://cloud.rostgaard.it/remote.php/dav/calendars/root/personal"</span> <span class="token string">"IndianRed"</span><span class="token punctuation">)</span> <span class="token comment">; google calendar ICS</span></span><br><span class="highlight-line">    <span class="token comment">;(cfw:ical-create-source "gcal" "https://..../basic.ics" "IndianRed") ; google calendar ICS</span></span><br><span class="highlight-line">   <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></code></pre>
<p>And because in denmark the work week starts monday I want to show monday as the first day:</p>
<pre class="language-lisp"><code class="language-lisp"><span class="highlight-line"><span class="token punctuation">(</span><span class="token keyword">setq</span> calendar-day-name-array</span><br><span class="highlight-line">     <span class="token punctuation">[</span><span class="token string">"Monday"</span> <span class="token string">"Tuesday"</span> <span class="token string">"Wednesday"</span> <span class="token string">"Thursday"</span> <span class="token string">"Friday"</span> <span class="token string">"Saturday"</span> <span class="token string">"Sunday"</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span></code></pre>

</div>
<p><a href="/">← Home</a></p>

    </main>

    <footer></footer>

    <!-- Current page: /p.backup/org-mode-calc/ -->
  </body>
</html>
